--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\caroline\school-age-children-and-covid\analysis\log\08_an_tablecontent_HRtable_HRforest_covid_tpp_prob.log
  log type:  text
 opened on:  14 Jul 2020, 14:47:51

. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) outcome(string)
  2. forvalues i=`min'/`max'{
  3. local endwith "_tab"
  4. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab
  5.         
.     use "$tempdir\cr_create_analysis_dataset_STSET_`outcome'.dta", clear
  6.         *put total N, PYFU and Rate in table
.         cou if `variable' == `i' & _d == 1
  7.         local event = r(N)
  8.     bysort `variable': egen total_follow_up = total(_t)
  9.         su total_follow_up if `variable' == `i'
 10.         local person_years = r(mean)
 11.         local rate = 1000*(`event'/`person_years')
 12.         
.         file write tablecontents (`event') _tab %10.0f (`person_years') _tab %3.2f (`rate') _tab
 13.         drop total_follow_up
 14.         
.         
.         *models
.         foreach modeltype of any minadj demogadj fulladj {
 15.         
.                 local noestimatesflag 0 /*reset*/
 16. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if "`modeltype'"=="fulladj" local endwith "_n"
 17. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
.                 
.                 if "`modeltype'"=="minadj" {
 18.                         cap estimates use ./output/an_univariable_cox_models_`outcome'_AGESEX_`variable'
 19.                         if _rc!=0 local noestimatesflag 1
 20.                         }
 21.                 if "`modeltype'"=="demogadj" {
 22.                         cap estimates use ./output/an_multivariate_cox_models_`outcome'_`variable'_DEMOGADJ_noeth
 23.                         if _rc!=0 local noestimatesflag 1
 24.                         }
 25.                 if "`modeltype'"=="fulladj" {
 26.                                 cap estimates use ./output/an_multivariate_cox_models_`outcome'_`variable'_MAINFULLYADJMODEL_noeth  
 27.                                 if _rc!=0 local noestimatesflag 1
 28.                                 }
 29.                 
.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 30.                         cap lincom `i'.`variable', eform
 31.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (")") `endwith'
 32.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 33.                         }
 34.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 35.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 36.                         if "`modeltype'"=="fulladj" {
 37.                                 local hr = r(estimate)
 38.                                 local lb = r(lb)
 39.                                 local ub = r(ub)
 40.                                 cap gen `variable'=.
 41.                                 testparm i.`variable'
 42.                                 *drop `variable'
.                                 }
 43.                 }       
 44.                 } /*min adj, full adj*/
 45.                 
. } /*variable levels*/
 46. 
. end

. ***********************************************************************************************************************
. *Generic code to write a full row of "ref category" to the output file
. cap prog drop refline

. prog define refline
  1. file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
  2. end

. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_tablecontents_HRtable_`outcome'.txt, t w replace 
(note: file ./output/an_tablecontents_HRtable_covid_tpp_prob.txt not found)

. 
. *Primary exposure
. refline

. outputHRsforvar, variable("kids_cat3") min(1) max(2) outcome(`outcome')
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

. file write tablecontents _n

. 
. *Number kids
. refline

. outputHRsforvar, variable("gp_number_kids") min(1) max(4) outcome(`outcome')
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

. file write tablecontents _n 

. 
. file close tablecontents

. 
. 
. log close
      name:  <unnamed>
       log:  E:\caroline\school-age-children-and-covid\analysis\log\08_an_tablecontent_HRtable_HRforest_covid_tpp_prob.log
  log type:  text
 closed on:  14 Jul 2020, 14:51:25
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
